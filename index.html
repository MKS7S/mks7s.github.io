<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Market Indices</title>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    th, td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }

    th {
        background-color: #383838;
		color: white;
    }

    .positive {
        background-color: green;
        color: white;
    }

    .negative {
        background-color: red;
        color: white;
    }

    .flag-img {
        max-width: 50px;
        max-height: 30px;
    }

    .state-closed {
        background-color: red;
        color: white;
    }

    .state-open {
        background-color: green;
        color: white;
    }
	
	.state-pre {
        background-color: #e7e700;
        color: white;
    }
</style>
</head>
<body>

<div id="table-container"></div>
<div id="avgworldindex"></div>
<div id="avgwrldweeklychng"></div>
<div id="giftyniftychng"></div>

<script>
    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
    }

    document.addEventListener("DOMContentLoaded", function() {
        fetch("https://priceapi.moneycontrol.com/technicalCompanyData/globalMarket/getGlobalIndicesListingData?view=overview&deviceType=W")
            .then(response => response.json())
            .then(data => {
                // Extracting percent_change values from the data
                const percentChanges = data.dataList.flatMap(market => market.data.map(rowData => parseFloat(rowData[data.header.findIndex(header => header.name === 'percent_change')])));

                // Calculating the average percent_change
                const averagePercentChange = percentChanges.reduce((total, value) => total + value, 0) / percentChanges.length;

                // Displaying the average in the div
                document.getElementById('avgworldindex').textContent = `Average Percent Change: ${averagePercentChange.toFixed(2)}%`;

                // Extracting weekly_per_change values from the data
                const weeklyChanges = data.dataList.flatMap(market => market.data.map(rowData => parseFloat(rowData[data.header.findIndex(header => header.name === 'weekly_per_change')])));

                // Calculating the average weekly_per_change
                const averageWeeklyChange = weeklyChanges.reduce((total, value) => total + value, 0) / weeklyChanges.length;

                // Displaying the average weekly_per_change in the div
                document.getElementById('avgwrldweeklychng').textContent = `Average Weekly Change: ${averageWeeklyChange.toFixed(2)}%`;

                // Dynamically generating the table
                const headersToShow = [
                    "name", "price", "net_change", "percent_change", 
                    "weekly_per_change", "technical_rating", "last_updated", 
                    "flag_url", "state"
                ];
                let tableHtml = '<table>';
                tableHtml += '<thead><tr>';
                headersToShow.forEach(headerName => {
                    tableHtml += `<th>${headerName}</th>`;
                });
                tableHtml += '</tr></thead>';
                tableHtml += '<tbody>';
                data.dataList.forEach(market => {
                    market.data.forEach(rowData => {
                        tableHtml += '<tr>';
                        rowData.forEach((cellData, j) => {
                            if (headersToShow.includes(data.header[j].name)) {
                                switch (data.header[j].name) {
                                    case 'last_updated':
                                        tableHtml += `<td>${formatDate(parseInt(cellData))}</td>`;
                                        break;
                                    case 'flag_url':
                                        tableHtml += `<td><img class="flag-img" src="${cellData}"></td>`;
                                        break;
                                    case 'percent_change':
                                    case 'weekly_per_change':
                                    case 'net_change':
                                        const value = parseFloat(cellData);
                                        const cellClass = value >= 0 ? 'positive' : 'negative';
                                        tableHtml += `<td class="${cellClass}">${cellData}</td>`;
                                        break;
                                    case 'state':
                                        const stateClass = cellData === 'CLOSED' ? 'state-closed' : cellData === 'OPEN' ? 'state-open' : cellData === 'PRE' ? 'state-pre' : '';
                                        tableHtml += `<td class="${stateClass}">${cellData}</td>`;
                                        break;
                                    default:
                                        tableHtml += `<td>${cellData}</td>`;
                                        break;
                                }
                            }
                        });
                        tableHtml += '</tr>';
                    });
                });
                tableHtml += '</tbody>';
                tableHtml += '</table>';
                document.getElementById('table-container').innerHTML = tableHtml;
            })
            .catch(error => console.error('Error fetching data:', error));
    });
</script>

</body>
</html>
