<html style="width: 100%;">
<head>
<meta charset="UTF-8">
<title>Live PCR Data</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }
    th, td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }
    th {
        background-color: #383838;
		color: white;
    }
    .positive {
        background-color: green;
        color: white;
    }
    .negative {
        background-color: red;
        color: white;
    }
    .flag-img {
        max-width: 50px;
        max-height: 30px;
    }
    .state-closed {
        background-color: red;
        color: white;
    }
    .state-open {
        background-color: green;
        color: white;
    }
	.state-pre {
        background-color: #e7e700;
        color: white;
    }
</style>
</head>
<body style="background: black;color: white;">



  
  
  
<p style="color: #6c6c6c;">Â© 2024 Development Rights MKS</p>
<h2>Concluded Data:</h2>
<div id="NiftyPCRavg"></div>

<h2>PCR Live {NIFTY}:</h2>

<select id="expiry-select"></select>




<div id="table-container2" style="width: 100%;"></div>




<!-- PCR DATA Data table-container2 -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    let selectedExpiry;
    const baseURL = "https://services.niftytrader.in/webapi/option/oi-pcr-data?type=niftypcr&expiry=";
    function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
    }
    function formatTime(timeString) {
        const time = new Date(`2000-01-01T${timeString}`);
        return `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}:${time.getSeconds().toString().padStart(2, '0')}`;
    }
    function fetchDataAndPopulateTable() {
        fetch(`${baseURL}${selectedExpiry}`, {
            headers: {
                "Authorization": "Basic bmlmdHlhcGl1c2VyOm5pZnR5YXBpdXNlckAyMTEwIw=="
            }
        })
        .then(response => response.json())
        .then(data => {
            const oiDatas = data.result.oiDatas;
            updateTable(oiDatas);
        })
        .catch(error => console.error('Error fetching data:', error));
    }
    function updateTable(oiDatas) {
        const headersToShow = ["Time", "Created At", "Expiry Date", "PCR", "Index Close"];
        let tableHtml = '<table>';
        tableHtml += '<thead><tr>';
        headersToShow.forEach(headerName => {
            tableHtml += `<th>${headerName}</th>`;
        });
        tableHtml += '</tr></thead>';
        tableHtml += '<tbody>';
        oiDatas.forEach(rowData => {
            tableHtml += '<tr>';
            Object.entries(rowData).forEach(([key, value]) => {
                let cellClass = '';
                if (key === 'time') {
                    value = formatTime(value);
                } else if (key === 'created_at' || key === 'expiry_date') {
                    value = formatDate(value);
                }
                tableHtml += `<td class="${cellClass}">${value}</td>`;
            });
            tableHtml += '</tr>';
        });
        tableHtml += '</tbody>';
        tableHtml += '</table>';
        document.getElementById('table-container2').innerHTML = tableHtml;
    }
  function populateExpiryDatesSelect(expiryDates) {
    const selectElement = document.getElementById('expiry-select');
    selectElement.innerHTML = "";
    expiryDates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = formatDate(date);
        selectElement.appendChild(option);
        fetchAndProcessData(date);
    });
    // Set "Merged Data" option as selected by default
    const mergedOption = document.createElement('option');
    mergedOption.value = 'merged';
    mergedOption.textContent = 'Merged Data';
    mergedOption.selected = true;
    selectElement.appendChild(mergedOption);
    // Fetch and display merged data by default
    fetchAndMergeDataForAllExpiries();
}
    function handleExpiryDateChange() {
        const selectedOption = document.getElementById('expiry-select').value;
        if (selectedOption === 'merged') {
            fetchAndMergeDataForAllExpiries();
        } else {
            selectedExpiry = selectedOption;
            fetchDataAndPopulateTable();
        }
    }
    function fetchAndMergeDataForAllExpiries() {
        const selectedExpiryOptions = Array.from(document.querySelectorAll('#expiry-select option'));
        selectedExpiryOptions.pop(); // Remove the last option which is "Merged Data"
        const promises = selectedExpiryOptions.map(option => {
            return fetchAndProcessData(option.value);
        });
        Promise.all(promises)
            .then(mergedData => {
                const averageMergedData = calculateAveragePCR(mergedData);
                updateTable(averageMergedData);
                const averagePCR = calculateAveragePCRValue(averageMergedData);
                document.getElementById('NiftyPCRavg').innerText = `Average PCR: ${averagePCR.toFixed(2)}`;
            })
            .catch(error => console.error('Error fetching and merging data:', error));
    }
    function calculateAveragePCRValue(averageMergedData) {
        const totalPCR = averageMergedData.reduce((acc, data) => acc + data.pcr, 0);
        const averagePCR = totalPCR / averageMergedData.length;
        return averagePCR;
    }
    function fetchAndProcessData(expiryDate) {
        return fetch(`${baseURL}${expiryDate}`, {
                headers: {
                    "Authorization": "Basic bmlmdHlhcGl1c2VyOm5pZnR5YXBpdXNlckAyMTEwIw=="
                }
            })
            .then(response => response.json())
            .then(data => {
                const oiDatas = data.result.oiDatas.map(entry => ({
                    time: entry.time,
                    createdAt: entry.created_at,
                    expiryDate: entry.expiry_date,
                    pcr: parseFloat(entry.pcr),
                    indexClose: parseFloat(entry.index_close)
                }));
                return { oiDatas };
            })
            .catch(error => {
                console.error(`Error fetching data for ${expiryDate}:`, error);
                return { oiDatas: [] };
            });
    }
    function calculateAveragePCR(dataArray) {
        const mergedData = {};
        dataArray.forEach(({ oiDatas }) => {
            oiDatas.forEach(({ time, createdAt, expiryDate, pcr, indexClose }) => {
                if (!mergedData[time]) {
                    mergedData[time] = { pcrCount: 0, pcrSum: 0, indexCloseCount: 0, indexCloseSum: 0, expiryDates: new Set(), createdAts: [] };
                }
                mergedData[time].pcrCount++;
                mergedData[time].pcrSum += pcr;
                mergedData[time].indexCloseCount++;
                mergedData[time].indexCloseSum += indexClose;
                mergedData[time].expiryDates.add(expiryDate);
                mergedData[time].createdAts.push(createdAt);
            });
        });
        const averageData = [];
        for (const [time, { pcrCount, pcrSum, indexCloseCount, indexCloseSum, expiryDates, createdAts }] of Object.entries(mergedData)) {
            const averagePCR = pcrSum / pcrCount;
            const averageIndexClose = indexCloseSum / indexCloseCount;
            const avgExpiryDates = Array.from(expiryDates).join(', ');
            const avgCreatedAt = calculateAverageDate(createdAts);
            averageData.push({ time, createdAt: avgCreatedAt, expiryDate: avgExpiryDates, pcr: averagePCR, indexClose: averageIndexClose });
        }
        return averageData;
    }
    function calculateAverageDate(dates) {
        const dateObjects = dates.map(date => new Date(date));
        const avgTimestamp = dateObjects.reduce((acc, curr) => acc + curr.getTime(), 0) / dateObjects.length;
        return new Date(avgTimestamp).toISOString().split('T')[0];
    }
    fetch(`${baseURL}`, {
        headers: {
            "Authorization": "Basic bmlmdHlhcGl1c2VyOm5pZnR5YXBpdXNlckAyMTEwIw=="
        }
    })
    .then(response => response.json())
    .then(data => {
        const expiryDates = data.result.oiExpiryDates;
        populateExpiryDatesSelect(expiryDates);
        selectedExpiry = expiryDates[9]; // Set initial selected expiry
        document.getElementById('expiry-select').addEventListener('change', handleExpiryDateChange);
        fetchDataAndPopulateTable();
    })
    .catch(error => console.error('Error fetching expiry dates:', error));
});
</script>


</body>
</html>
